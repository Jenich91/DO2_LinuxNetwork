# Сети в Linux

Настройка сетей в Linux на виртуальных машинах.


## Contents


1. [Инструмент ipcalc](#part-1-инструмент-ipcalc)
2. [Статическая маршрутизация между двумя машинами](#part-2-статическая-маршрутизация-между-двумя-машинами)
3. [Утилита iperf3](#part-3-утилита-iperf3)
4. [Сетевой экран](#part-4-сетевой-экран)
5. [Статическая маршрутизация сети](#part-5-статическая-маршрутизация-сети)
6. [Динамическая настройка IP с помощью DHCP](#part-6-динамическая-настройка-ip-с-помощью-dhcp)
7. [NAT](#part-7-nat)
8. [Допополнительно. Знакомство с SSH Tunnels](#part-8-дополнительно-знакомство-с-ssh-tunnels)

## Part 1. Инструмент **ipcalc**
Чтобы установить ipcalc - 'sudo apt install ipcalc'
ipcalc вычисляет широковещательный адрес, диапазон хостов, шаблон сетевой маски по полученному IP и сетевой маске.
Синтаксис -  ipcalc *ip адрес*/*маска подсети* или *префиксная форма записи подсети*

#### 1.1. Сети и маски
##### 1) Адрес сети *192.167.38.54/13*
      192.160.0.0/13

![linux](images/Screen%20Shot%202022-01-14%20at%2016.21.57.png "")

##### 2) Перевод маски
      *255.255.255.0* в префиксную и двоичную запись - /24, 11111111.11111111.11111111.00000000 
      */15* в обычную и двоичную - 255.254.0.0 , 11111111.1111111 0.00000000.00000000  
      *11111111.11111111.11111111.11110000* в обычную и префиксную - 255.255.255.240, /28 

##### 3) Минимальный и максимальный хост в сети *12.167.38.4* при масках;
      */8*
      HostMin:  12.0.0.1          00001100.00000000.00000000.00000001
      HostMax:  12.255.255.254    00001100.11111111.11111111.11111110

      *11111111.11111111.00000000.00000000*
      HostMin:  12.167.0.1        00001100.10100111.00000000.00000001
      HostMax:  12.167.255.254    00001100.10100111.11111111.11111110

      *255.255.254.0*
      HostMin:  12.167.38.1       00001100.10100111.00100110.00000001
      HostMax:  12.167.39.254     00001100.10100111.00100111.11111110

      */4*
      HostMin:	0.0.0.1	    00000000.00000000.00000000.00000001
      HostMax:	15.255.255.254  00001111.11111111.11111111.11111110

![linux](https://wmpics.pics/di-87W0.png "")

#### 1.2. localhost
##### Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP:
      194.34.23.100/16 - no
      127.0.0.2/24 - yes
      127.1.0.1/8 - yes
      128.0.0.1/8 - no

![linux](https://wmpics.pics/di-RUQI.png "")

#### 1.3. Диапазоны и сегменты сетей
##### Определить и записать в отчёт:
##### 1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных:
      10.0.0.45/8 - private
      134.43.0.2/16 - public
      192.168.4.2/16 - private
      172.20.250.4/12 - private
      172.0.2.1/12 - public
      192.172.0.1/12 - 
            192.160.0.0 - 192.167.255.255 - public,
            192.168.0.0 — 192.168.255.255 - private,
            192.169.0.0 - 192.175.255.255 - public
      172.68.0.2/12 - public
      172.16.255.255/12 - private
      10.10.10.10/8 - private
      192.169.168.1/16 - public

![linux](images/Screen%20Shot%202022-01-14%20at%2017.09.00.png "")

##### 2) какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*:
      10.0.0.1 - no
      10.10.0.2 - yes
      10.10.10.10 - yes
      10.10.100.1 - no
      10.10.1.255 - yes

![linux](images/Screen%20Shot%202022-01-14%20at%2017.11.56.png "")

## Part 2. Статическая маршрутизация между двумя машинами

##### Поднять две виртуальные машины (далее -- ws1 и ws2)

![linux](https://i.ibb.co/NKmkpk5/Screen-Shot-2022-01-16-at-15-50-33.png "")

##### С помощью команды `ip a` посмотреть существующие сетевые интерфейсы

![linux](https://i.ibb.co/9pXzgqW/Screen-Shot-2022-01-16-at-15-29-25.png "")

##### Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - *192.168.100.10*, маска */16*, ws2 - *172.24.116.8*, маска */12*

![linux](https://i.ibb.co/VJtdwfb/Screen-Shot-2022-01-15-at-21-25-05.png "")

##### Выполнить команду `netplan apply` для перезапуска сервиса сети
![linux](https://i.ibb.co/brdYWhv/Screen-Shot-2022-01-16-at-15-56-26.png "")

#### 2.1. Добавление статического маршрута вручную
##### Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`
##### Пропинговать соединение между машинами
![linux](https://i.ibb.co/qCjHvB4/Screen-Shot-2022-01-16-at-16-30-55.png "")

#### 2.2. Добавление статического маршрута с сохранением
##### Перезапустить машины
##### Добавить статический маршрут от одной машины до другой с помощью файла *etc/netplan/00-installer-config.yaml*
![linux](https://i.ibb.co/4YvH1C4/Screen-Shot-2022-01-16-at-19-33-41.png "")

##### Пропинговать соединение между машинами
![linux](https://i.ibb.co/4fRLnf7/Screen-Shot-2022-01-16-at-19-36-42.png "")

## Part 3. Утилита **iperf3**

Для установки выполните:      
sudo apt install iperf3 

#### 3.1. Скорость соединения
##### Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps
Бит в секунду, бит/с (англ. bits per second, bps) — базовая единица измерения скорости передачи информации, используемая на физическом уровне сетевой модели OSI или TCP/IP.  
На более высоких уровнях сетевых моделей, как правило, используется более крупная единица — байт в секунду (Б/c или Bps, от англ. bytes per second) равная 8 бит/c.     
Для обозначения больших скоростей передачи применяют более крупные единицы, образованные с помощью приставок системы СИ кило-, мега-, гига- и т. п. получая:      
килобиты в секунду — кбит/с (kbps, kbit/s или kb/s)   
мегабиты в секунду — Мбит/с (Mbps, Mbit/s или Mb/s)   
гигабиты в секунду — Гбит/с (Gbps, Gbit/s или Gb/s)   
Часто путают Mb/s и MB/s (1 MB/s = 8 Mb/s), поэтому рекомендуется использовать сокращение Mbit/s      


      8 Мегабит в секунду =  1 Мегабайт в секунду

      100 Мегабайт в секунду =  819200 Килобит в секунду

      1 Гигабит в секунду =  1024 Мегабит в секунду

#### 3.2. Утилита **iperf3**
##### Измерить скорость соединения между ws1 и ws2
![linux](https://i.ibb.co/kKyd5J9/Screen-Shot-2022-01-16-at-20-25-20.png "")
![linux](https://i.ibb.co/8KPrmnf/Screen-Shot-2022-01-16-at-20-26-07.png "")

## Part 4. Сетевой экран

#### 4.1. Утилита **iptables**
##### Создать файл */etc/firewall.sh*, имитирующий фаерволл, на ws1 и ws2:
```shell
#!/bin/sh

# Удаление всех правил в таблице "filter" (по-умолчанию).
iptables –F
iptables -X
```

синтаксис утилиты:
sudo iptables [-t таблица] -A [цепочка] -p протокол [--sport начальный_порт_отправителя:конечный_порт_отправителя] [--dport начальный_порт_назначения:конечный_порт_назначения] -j [действие]

##### Нужно добавить в файл подряд следующие правила:
##### 1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)
##### 2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)
##### 3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)
##### 4) запретить *echo reply* (машина не должна "пинговаться”)
##### 5) разрешить *echo reply* (машина должна "пинговаться")

##### Запустить файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`
![linux](https://i.ibb.co/Ypp0Ld2/Screenshot-71.png "")

![linux](https://i.ibb.co/3WTrxR9/Screenshot-73.png "")

iptables структурно состоит из таблиц, в которые входят цепочки, в свою очередь содержащие наборы правил. 

После инициализации все цепочки пустые и не содержат никаких правил. Но каждая цепочка имеет действие по умолчанию (стандартно - ACCEPT), которое будет применено к пакету, если он прошел всю цепочку и не попал под действие ни одного правила.

Каждое правило состоит из трех составляющих: критерия, действия и счетчика. Если пакет удовлетворяет критериям, то к нему применяется действие и он учитывается счетчиком. Если не указан критерий, то действие применяется ко всем пакетам.

Попав в цепочку пакет последовательно проходит правила в порядке их перечисления до первого срабатывания. Дальнейшее его движение зависит от типа действия, если действие нетерминальное - пакет продолжит движение по цепочке, иначе - покидает ее.

Если ранее было объявленно запрещающее правило, оно не отменяется разрешающим объявленным позднее, DROP является терминальным правилом, после этого пакет покидает цепочку.

#### 4.2. Утилита **nmap**
##### Командой **ping** найти машину, которая не "пингуется", после чего утилитой **nmap** показать, что хост машины запущен
Утилита nmap в процессе сканирования сети перебирает доступный диапазон портов и пытается подключиться к каждому из них.

$ nmap опции адрес
![linux](https://i.ibb.co/DRMLhmP/Screen-Shot-2022-01-18-at-17-29-40.png "")

##### Сохранить дампы образов виртуальных машин
![linux](https://i.ibb.co/n3FgW3s/Screen-Shot-2022-01-18-at-17-34-58.png "")

## Part 5. Статическая маршрутизация сети

Сеть:
<img src="misc/images/part5_network.png" alt="part5_network" width="500"/>

##### Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))

#### 5.1. Настройка адресов машин
##### Настроить конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке.
![linux](https://i.ibb.co/yFz7dgj/Screen-Shot-2022-01-18-at-20-56-10.png "")
![linux](https://i.ibb.co/BCGHX9L/Screen-Shot-2022-01-18-at-20-56-13.png "")
![linux](https://i.ibb.co/XZDcPCg/Screen-Shot-2022-01-18-at-20-56-17.png "")
![linux](https://i.ibb.co/8YrS0x5/Screen-Shot-2022-01-18-at-20-56-19.png "")
![linux](https://i.ibb.co/0mG6bZC/Screen-Shot-2022-01-18-at-20-56-20.png "")

##### Перезапустить сервис сети. Если ошибок нет, то командой `ip -4 a` проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.
![linux](https://i.ibb.co/ZBPgvQH/Screen-Shot-2022-01-18-at-21-13-54.png "")
![linux](https://i.ibb.co/Phm4TsB/Screen-Shot-2022-01-18-at-21-13-56.png "")
![linux](https://i.ibb.co/y5B0wZJ/Screen-Shot-2022-01-18-at-21-13-58.png "")
![linux](https://i.ibb.co/93JxBGC/Screen-Shot-2022-01-18-at-21-14-00.png "")
![linux](https://i.ibb.co/HnCG8Dd/Screen-Shot-2022-01-18-at-21-14-01.png "")

#### 5.2. Включение .
##### Для включения переадресации IP, выполните команду на роутерах:
`sysctl -w net.ipv4.ip_forward=1`
*При таком подходе переадресация не будет работать после перезагрузки системы.*
![linux](https://i.ibb.co/0h29bZx/Screen-Shot-2022-01-19-at-16-24-23.png "")
##### Откройте файл */etc/sysctl.conf* и добавьте в него следующую строку:
`net.ipv4.ip_forward = 1`
*При использовании этого подхода, IP-переадресация включена на постоянной основе.*
![linux](https://i.ibb.co/prh2BZb/Screen-Shot-2022-01-19-at-16-34-16.png "")

#### 5.3. Установка маршрута по-умолчанию
Пример вывода команды `ip r` после добавления шлюза:
```
default via 10.10.0.1 dev eth0
10.10.0.0/18 dev eth0 proto kernel scope link src 10.10.0.2
```
##### Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить gateway4 \[ip роутера\] в файле конфигураций
![linux](https://i.ibb.co/jbGs4FG/Screen-Shot-2022-01-19-at-16-47-05.png "")
![linux](https://i.ibb.co/R7yrzgH/Screen-Shot-2022-01-19-at-16-47-16.png "")
![linux](https://i.ibb.co/rfFN2Y0/Screen-Shot-2022-01-19-at-16-47-17.png "")

##### Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации
![linux](https://i.ibb.co/ZN0Y385/Screen-Shot-2022-01-19-at-17-37-16.png "")
![linux](https://i.ibb.co/tLCP66W/Screen-Shot-2022-01-19-at-17-37-19.png "")
![linux](https://i.ibb.co/rfR3LXX/Screen-Shot-2022-01-19-at-17-37-21.png "")

##### Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:
`tcpdump -tn -i eth1`
![linux](https://i.ibb.co/8zzTNP0/Screen-Shot-2022-01-19-at-18-56-26.png "")
![linux](https://i.ibb.co/xL07c2r/Screen-Shot-2022-01-19-at-18-56-28.png "")

#### 5.4. Добавление статических маршрутов
##### Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций. Пример для r1 маршрута в сетку 10.20.0.0/26:
```shell
# Добавить в конец описания сетевого интерфейса eth1:
- to: 10.20.0.0
  via: 10.100.0.12
```

![linux](https://i.ibb.co/z5xH50m/Screen-Shot-2022-01-19-at-21-20-05.png "")

##### Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах. Пример таблицы на r1:
```
10.100.0.0/16 dev eth1 proto kernel scope link src 10.100.0.11
10.20.0.0/26 via 10.100.0.12 dev eth1
10.10.0.0/18 dev eth0 proto kernel scope link src 10.10.0.1
```

![linux](https://i.ibb.co/hY9jSgw/Screen-Shot-2022-01-19-at-21-20-22.png "")

##### Запустить команды на ws11:
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`
![linux](https://i.ibb.co/gVzX3Lw/Screen-Shot-2022-01-19-at-21-22-21.png "")

- В отчёте объяснить, почему для адреса 10.10.0.0/\[порт сети\] был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по-умолчанию.

Маршрут по умолчанию — это конфигурация протокола IP, которая устанавливает правило пересылки для пакетов, когда в таблице маршрутизации или других механизмах маршрутизации нет конкретного адреса узла следующего перехода.
Маршрутизация осуществляется по принципу наибольшего совпадения маски.
Маршрут по умолчанию в IPv4 обозначается как нулевой адрес , 0.0.0.0/0 в нотации CIDR. Маска подсети указывается как / 0 , что фактически указывает все сети и является кратчайшим возможным совпадением. Поиск маршрута, который не соответствует ни одному другому правилу, возвращается к этому маршруту.

#### 5.5. Построение списка маршрутизаторов
Пример вывода утилиты **traceroute** после добавления шлюза:
```
1 10.10.0.1 0 ms 1 ms 0 ms
2 10.100.0.12 1 ms 0 ms 1 ms
3 10.20.0.10 12 ms 1 ms 3 ms
```
##### Запустить на r1 команду дампа:
`tcpdump -tnv -i eth0`
##### При помощи утилиты **traceroute** построить список маршрутизаторов на пути от ws11 до ws21
- В отчёт поместить скрины с вызовом и выводом использованных команд (tcpdump и traceroute).
- В отчёте, опираясь на вывод, полученный из дампа на r1, объяснить принцип работы построения пути при помощи **traceroute**.

![linux](https://i.ibb.co/0fBZyFv/Screen-Shot-2022-01-20-at-18-05-07.png "")
![linux](https://i.ibb.co/0CdqYfM/Screen-Shot-2022-01-20-at-18-05-08.png "")
![linux](https://i.ibb.co/tx3pp3h/Screen-Shot-2022-01-20-at-18-05-20.png "")

Информация в сети передается в виде пакетов. Поток данных разбивается специальным программным обеспечением на небольшие пакеты и передается через сеть интернет на целевой узел, а там собирается обратно.

Каждый пакет проходит на своем пути определенное количество узлов, пока достигнет своей цели. Причем, каждый пакет имеет свое время жизни. Это количество узлов, которые может пройти пакет перед тем, как он будет уничтожен. Этот параметр записывается в заголовке TTL, каждый маршрутизатор, через который будет проходить пакет уменьшает его на единицу. При TTL=0 пакет уничтожается, а отправителю отсылается сообщение Time Exceeded.

Команда traceroute linux использует UDP пакеты. Она отправляет пакет с TTL=1 и смотрит адрес ответившего узла, дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который, скорее всего, не занят. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен трассировка считается завершенной.

#### 5.6. Использование протокола **ICMP** при маршрутизации
##### Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
`tcpdump -n -i eth0 icmp`
##### Пропинговать с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды:
`ping -c 1 10.30.0.111`

![linux](https://i.ibb.co/ZLSR7C8/Screen-Shot-2022-01-20-at-18-17-11.png "")
![linux](https://i.ibb.co/hRcq5Kr/Screen-Shot-2022-01-20-at-18-17-12.png "")

##### Сохранить дампы образов виртуальных машин

## Part 6. Динамическая настройка IP с помощью **DHCP**

##### Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`
![linux](https://i.ibb.co/6BW5hZZ/Screen-Shot-2022-01-24-at-15-54-35.png "")

##### Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:
##### 1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. Пример файла для r2:
```shell
subnet 10.100.0.0 netmask 255.255.0.0 {}

subnet 10.20.0.0 netmask 255.255.255.192
{
    range 10.20.0.2 10.20.0.50;
    option routers 10.20.0.1;
    option domain-name-servers 10.20.0.1;
}
```

Установить dhcp-server
sudo apt-get install isc-dhcp-server
Отредактировать конфиг
![linux](https://i.ibb.co/48nKNRP/Screen-Shot-2022-01-24-at-15-55-29.png "")

##### 2) в файле *resolv.conf* прописать `nameserver 8.8.8.8.`
Если просто отредактировать resolv.conf, попытка `systemctl restart isc-dhcp-server` будет выдавать ошибку, а после перезагрузки dns не применится и в resolv.conf будет другое значение

Причина:
При изменении сетевой конфигурации, запуске и остановке процессов, некоторым программам необходимо динамически изменять файл resolv.conf. При одновременном доступе программы мешают друг другу и сохраняют неверную информацию в файл. Утилита resolvconf действует как посредник между программами, которые предоставляют информацию о сервере имен, и программами, которые используют информацию о сервере имен.
При этом файл resolv.conf заменяется символической ссылкой на /run/resolvconf/resolv.conf и программы используют динамически сгенерированный файл. В системе без службы resolvconf.service файл resolv.conf поддерживается вручную или набором скриптов. И эти скрипты могут мешать друг другу при попытках одновременного доступа к файлу.

Всё работало хорошо, пока не появились NetworkManager и Systemd. Система инициализации Systemd имеет свой собственный резолвер systemd-resolved, запущенный по умолчанию и требующий отдельной настройки. А NetworkManager пытается дружить со всеми — с resolvconf, с Systemd, с наиболее распространёнными DNS-резолверами.

Решение:
Установите пакет resolvconf
sudo apt install resolvconf

Служба предоставляет остальным программам централизованный интерфейс для добавления и удаления записей в /etc/resolv.conf при изменении сетевой конфигурации, запуске и остановке процессов и т.д.
После установки /etc/resolv.conf будет представлять из себя ссылку на /run/resolvconf/resolv.conf.
При этом исходный файл /etc/resolv.conf (который на самом деле ссылка на /run/systemd/resolve/resolv.conf) будет сохранен как original в директории /etc/resolvconf/resolv.conf.d/ (чтобы восстановить его при удалении службы resolvconf.service). В этой же директории есть есть еще три файла — base, head и tail — которые позволяют вручную добавить записи в динамически формируемый /run/resolvconf/resolv.conf.

Отредактируйте /etc/resolvconf/resolv.conf.d/tail     
Заменить значение nameserver на 8.8.8.8   

Отредактируйте /run/systemd/resolve/stub-resolv.conf  
Заменить значение nameserver на 8.8.8.8   

Отредактируйте /etc/resolv.conf     
Заменить значение nameserver на 8.8.8.8   

-    ![linux](https://wmpics.pics/di-VIM2.png "")

##### Перезагрузить службу **DHCP**. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.

Перезагружаем службу, перезагружаем машину      
-    ![linux](https://wmpics.pics/di-8AAD.png "")

Проверяем что dns поменялся - nslookup ya.ru    
![linux](https://i.ibb.co/TMNjyvN/Screen-Shot-2022-01-21-at-18-54-47.png "")

Проверяем соединение    
[linux](https://i.ibb.co/njRRjTb/Screen-Shot-2022-01-21-at-19-00-39.png "")

##### Для r1 настроить аналогично, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты
1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.
![linux](https://i.ibb.co/PwDR3kj/Screen-Shot-2022-01-24-at-16-28-08.png "")
2) в файле resolv.conf прописать nameserver 8.8.8.8.
![linux](https://i.ibb.co/0JFJwR7/Screen-Shot-2022-01-21-at-21-29-53.png "")
3) Проверяем что dns поменялся
![linux](https://i.ibb.co/xGcJcWc/Screen-Shot-2022-01-21-at-21-43-06.png "")

##### Запросить с ws11 обновление ip адреса
до
![linux](https://i.ibb.co/qDPRsVS/Screen-Shot-2022-01-21-at-21-45-35.png "")
перезгрузить или запросить новый ip через - sudo dhclient     

после 
![linux](https://i.ibb.co/M6SY3zx/Screen-Shot-2022-01-21-at-21-42-35.png "")

Опция routers позволяет указать адрес DHCP сервера для получения IP адресов машинами подсети
Опция domain-name-severs позволяет указать адрес dns сервера, для получения машинами информации о доменах.

Каждая  сетевая карточка  имеет  уникальный собственный MAC-адрес. Допустим, вам нужно связать  какой-то  MAC-адрес  с  определенным  IP-адресом.  Для этого использовалась конструкция host:

host myhost {
      hardware ethernet xx:xx:xx:xx:xx:xx;
      fixed-address someIpAddress;
}

Ее нужно вставить в ту конструкцию подсети subnet, которой принадлежит
назначаемый IP-адрес. Данная конструкция означает, что компьютеру с
аппаратным адресом xx:xx:xx:xx:xx:xx будет назначен IP-адрес.
![linux](https://i.ibb.co/4f8TCp2/Screen-Shot-2022-01-21-at-21-51-56.png "")

В отчёте описать, какими опциями DHCP сервера пользовались в данном пункте.
option routers - это адрес шлюза по умолчанию
option domain-name-servers - это адрес сервера DNS

## Part 7. **NAT**
##### В файле */etc/apache2/ports.conf* на ws22 и r2 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным
![linux](https://i.ibb.co/q7xS4MN/Screen-Shot-2022-01-24-at-16-46-42.png "")
![linux](https://i.ibb.co/y6sTCm5/Screen-Shot-2022-01-24-at-16-45-00.png "")
##### Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1
![linux](https://i.ibb.co/0JX0P4H/Screen-Shot-2022-01-24-at-17-11-55.png "")
![linux](https://i.ibb.co/4YrgMYG/Screen-Shot-2022-01-24-at-17-11-56.png "")
##### Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
##### 1) Удаление правил в таблице filter - `iptables -F`
##### 2) Удаление правил в таблице "NAT" - `iptables -F -t nat`
##### 3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`
![linux](https://i.ibb.co/Cv6np6C/Screen-Shot-2022-01-24-at-17-35-08.png "")
##### Запускать файл также, как в Части 4
##### Проверить соединение между ws22 и r1 командой `ping`
*При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1*
![linux](https://i.ibb.co/NsQmysP/Screen-Shot-2022-01-24-at-17-34-43.png "")
![linux](https://i.ibb.co/hdZc2VZ/Screen-Shot-2022-01-24-at-17-25-47.png "")

##### Добавить в файл ещё одно правило:
##### 4) Разрешить маршрутизацию всех пакетов протокола **ICMP**
##### Запускать файл также, как в Части 4
##### Проверить соединение между ws22 и r1 командой `ping`
*При запуске файла с этими правилами, ws22 должна "пинговаться" с r1*
![linux](https://i.ibb.co/Fx6DQyd/Screen-Shot-2022-01-24-at-18-33-28.png "")
![linux](https://i.ibb.co/tsKfd97/Screen-Shot-2022-01-24-at-18-33-29.png "")

##### Добавить в файл ещё два правила:
##### 5) Включить **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
*Совет: стоит подумать о маршрутизации внутренних пакетов, а также внешних пакетов с установленным соединением*
##### 6) Включить **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
*Совет: стоит учесть, что при попытке подключения возникнет новое tcp-соединение, предназначенное ws22 и 80 порту*
![linux](https://i.postimg.cc/Fz505nZP/Screen-Shot-2022-01-25-at-19-26-22.png "")

##### Запускать файл также, как в Части 4
*Перед тестированием рекомендуется отключить сетевой интерфейс **NAT** (его наличие можно проверить командой `ip a`) в VirtualBox, если он включен*
![linux](https://i.ibb.co/WcCbHbW/Screen-Shot-2022-01-25-at-19-56-38.png "")

##### Проверить соединение по TCP для **SNAT**, для этого с ws22 подключиться к серверу Apache на r1 командой:
`telnet [адрес] [порт]`
![linux](https://i.ibb.co/WF5BC6x/Screen-Shot-2022-01-25-at-19-19-46.png "")

##### Проверить соединение по TCP для **DNAT**, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080)
В отчёт поместить скрины с вызовом и выводом использованных команд.
![linux](https://i.ibb.co/qsFTYKk/Screen-Shot-2022-01-25-at-19-19-45.png "")

## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

##### Запустить веб-сервер **Apache** на ws22 только на localhost (то есть не изменять файл */etc/apache2/ports.conf* или, если был изменен ранее, вернуть строку `Listen 80`)
- ![linux](https://i.imgur.com/HMBfvP7.png "")
##### Воспользоваться *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21
- ![linux](https://i.imgur.com/eOZzxTR.png "")
##### Воспользоваться *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11
- ![linux](https://i.imgur.com/aKWNHlz.png "")
##### Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:
`telnet 127.0.0.1 [локальный порт]`

- ![linux](https://i.imgur.com/rUMXBew.png "")
- ![linux](https://i.imgur.com/Hnng2M0.png "")


